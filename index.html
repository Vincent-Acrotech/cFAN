<!DOCTYPE html>
<html>

	<head> 
		<meta charset="utf-8">
		<title>Discovery for cFAN</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<style>
			body {font-family: Arial, Helvetica, sans-serif;}
			* {box-sizing: border-box;}

			/* Button used to open the contact form - fixed at the bottom of the page */
			.open-button {
			  background-color: #555;
			  color: white;
			  padding: 16px 20px;
			  border: none;
			  cursor: pointer;
			  opacity: 0.8;
			  position: fixed;
			  bottom: 23px;
			  right: 28px;
			  width: 280px;
			}

			/* The popup form - hidden by default */
			.form-popup {
			  display: none;
			  position: fixed;
			  bottom: 0;
			  right: 15px;
			  border: 3px solid #f1f1f1;
			  z-index: 9;
			}

			/* Add styles to the form container */
			.form-container {
			  max-width: 300px;
			  padding: 10px;
			  background-color: white;
			}

			/* Full-width input fields */
			.form-container input[type=text], .form-container input[type=password] {
			  width: 100%;
			  padding: 15px;
			  margin: 5px 0 22px 0;
			  border: none;
			  background: #f1f1f1;
			}

			/* When the inputs get focus, do something */
			.form-container input[type=text]:focus, .form-container input[type=password]:focus {
			  background-color: #ddd;
			  outline: none;
			}

			/* Set a style for the submit/login button */
			.form-container .btn {
			  background-color: #04AA6D;
			  color: white;
			  padding: 16px 20px;
			  border: none;
			  cursor: pointer;
			  width: 100%;
			  margin-bottom:10px;
			  opacity: 0.8;
			}

			/* Add a red background color to the cancel button */
			.form-container .cancel {
			  background-color: red;
			}

			/* Add some hover effects to buttons */
			.form-container .btn:hover, .open-button:hover {
			  opacity: 1;
			}
		</style>
				
	</head>
		
	<body style="text-align:center">	
		<div class="form-popup" id="myForm">
			<form action="/action_page.php" class="form-container">
				<h1>Data X'fer</h1>
				<label for="email"><b>Email</b></label>
				<input type="text" placeholder="Enter Email" name="email" required>

				<label for="psw"><b>Password</b></label>
				<input type="password" placeholder="Enter Password" name="psw" required>

				<button type="submit" class="btn">Login</button>
				<button type="button" class="btn cancel" onclick="closeForm()">Close</button>
			</form>
		</div>
	
		<h1>
			<img src="./image/LaNetworkWired.svg" alt="chip" width="48" height="48" "
			style="vertical-align:top"> Discovery
		</h1>			
		
		<label id="test1"></label>
		<label id="test2"></label>
		<label id="test3"></label>
		<label id="test4"></label>
		
		<center>			
			<button id="linkBtn" onclick="showOneNodeImg()"><img id="imageLink" width=32 height=32 src="./image/WpfConnected.svg"></button>&nbsp;&nbsp;&nbsp;
			<button id="unlinkBtn" onclick="drawImgThin(2)"><img id="imageUnlink" width=32 height=32 src="./image/WpfDisconnected.svg"></button>&nbsp;&nbsp;&nbsp;
			<button id="xferBtn" onclick="Init_Node_Info()"><img id="imageXfer" width=32 height=32 src="./image/IconParkOutlineCommunication.svg"></button>&nbsp;&nbsp;&nbsp;
			<button id="resumeBtn" onclick="resumeConn()"><img id="image" width=32 height=32 src="./image/MaterialSymbolsRestartAltRounded.svg"></button>&nbsp;&nbsp;&nbsp;
			<button id="oprModeBtn" onclick="changeMode()"><img id="imagMode" width=32 height=32 src="./image/IconoirNetworkReverse.svg"></button>&nbsp;&nbsp;&nbsp;
			<button id="readMeBtn" onclick="sendMessage()"><img id="imagReadme" width=32 height=32 src="./image/OcticonBook.svg"></button>&nbsp;&nbsp;&nbsp;&nbsp;
			<button id="bleBtn" onclick="linkBluetoothClick()"><img id="imgBle" width=32 height=32 src="./image/MdiBluetoothOff.svg"></button>
		</center>
		
		<center>
			<canvas id="myCanvas" width="450" height="700" 
				style="border:1px solid #d3d3d3;background:#ffffff">
				<img src="./image/voip-gateway-128Thin.png" alt="gatewayThin" width=128 height=128 id="imgGatewayThin">
				<img src="./image/voip-gateway-128Thick.png" alt="gatewayThick" width=128 height=128 id="imgGatewayThick">
				<img src="./image/voip-gateway-128Clr.png" alt="gatewayClr" width=128 height=128 id="imgGatewayClr">
				<img src="./image/IconParkOutlineCpuThin.svg" alt="chipThin" width=128 height=128 id="imgDrtThin">				
				<img src="./image/IconParkOutlineCpuThick.svg" alt="chipThick" width=128 height=128 id="imgDrtThick">				
				<img src="./image/IconParkOutlineCpuClr.svg" alt="chipClr" width=128 height=128 id="imgDrtClr">				
				<img src="./image/Disconnected.svg" alt="drtDisconn" width=128 height=128 id="imgDisconn">	
				<img src="./image/Connected.svg" alt="drtConn" width=128 height=128 id="imgConn">
				<img src="./image/blank.png" alt="dvcBlank" width=128 height=128 id="imgBlank">				
				<img src="./image/FlatColorIconsDownload.svg" alt="dvcBlank" width=128 height=128 id="imgDownload">				
				<img src="./image/FlatColorIconsUpload.svg" alt="dvcBlank" width=128 height=128 id="imgUpload">				
			</canvas>				
		</center>
		
		<script type="text/javascript">
			let device;
			let notifyCharacteristic;
			let writeCharacteristic;

			const serviceUuid = '30774092-df5b-4359-be9e-824c3bf779ac';
			const writeCharacteristicUuid = 'e36fe48e-950b-4d44-b208-c5a3b0448634';
			const notifyCharacteristicUuid = '4e68336a-2a37-497a-a801-fe20000e9fc1';

			const messageStore = {};

			var drt1json,
				drt2json,
				drt3json,
				drt4json,
				drt5json;
		
			var	enConnBLE = 1,
				disconnCmd = 0,
				connStatus = 0;

			// arrangeArray[0] = node name of LBText2P.text
			// arrangeArray[1] = node name of Node1TextP.text
			// arrangeArray[2] = node name of Node2TextP.text
			// arrangeArray[3] = node name of Node3TextP.text
			// content: 0: cFAN_NODE_1, 1: cFAN_NODE_2
			//			2: cFAN_NODE_3, 3: cFAN_NODE_4
			let arrangeArray = [0,0,0,0];
			
			const connDeviceName = "cFAN_ROOT";

			/*** DEFAULT information for cFAN ***/
			const cFAN_GW_DFT	  = {DeviceName: "cFAN_DISCOVERY"};

			const cFAN_ROOT_DFT   = {DeviceName: "cFAN_ROOT",
									 DeviceUUID: "0000000-0000-0000-0000-000000000000",
									 DeviceLoc : "DFM-UUU"};
			
			const cFAN_LB_DFT = 	{DeviceName: "cFAN_LB",
									 DeviceUUID: "0000000-0000-0000-0000-000000000000",
									 DeviceLoc : "DFM-UUU"};
			
			const cFAN_NODE_1_DFT = {DeviceName: "cFAN_NODE_2",
									 DeviceUUID: "0000000-0000-0000-0000-000000000000",
									 DeviceLoc : "DFM-UUU"};

			const cFAN_NODE_2_DFT = {DeviceName: "cFAN_NODE_3",
									 DeviceUUID: "0000000-0000-0000-0000-000000000000",
									 DeviceLoc : "DFM-UUU"};

			const cFAN_NODE_3_DFT = {DeviceName: "cFAN_NODE_4",
									 DeviceUUID: "0000000-0000-0000-0000-000000000000",
									 DeviceLoc : "DFM-UUU"};

			/*** Chip information for cFAN ***/	
			const cFAN_GW_INFO	   = {DeviceName: "cFAN_DISCOVERY"};

			const cFAN_ROOT_INFO   = {DeviceName: "cFAN_ROOT",
									 DeviceUUID : "98007e9c-48d4-4522-93b1-05044c7e756b",
									 DeviceLoc  : "DFM-7084"};
			
			const cFAN_LB_INFO 	   = {DeviceName: "cFAN_NODE_1",
									 DeviceUUID : "155b666f-bb69-42a6-ac5c-bddcc141c8ed",
									 DeviceLoc  : "NDW-8864"};
			
			const cFAN_NODE_1_INFO = {DeviceName: "cFAN_NODE_2",
									 DeviceUUID : "aea1770b-eae4-410d-bb65-8d4b3cabddaa",
									 DeviceLoc  : "EMG-5760"};

			const cFAN_NODE_2_INFO = {DeviceName: "cFAN_NODE_3",
									 DeviceUUID : "565d421d-5107-4c89-9107-a718f986f63f",
									 DeviceLoc  : "TMB-7052"};

			const cFAN_NODE_3_INFO = {DeviceName: "cFAN_NODE_4",
									 DeviceUUID : "9a0b9a6b-7c49-4d0e-b610-fab91733eab8",
									 DeviceLoc  : "SXC-4043"};

			var	netMode = false,
				uploadCnt = 0,
				downloadCnt = 0;
				netmodeEdge = 0;
				updnMode = 1;

			var GW_INFO = {
								DeviceName : "",
								DeviceUUID : "",
								DeviceLoc  : ""
							};
			
			var ROOT_INFO = {
								DeviceName : "",
								DeviceUUID : "",
								DeviceLoc  : ""
							};

			var LB_INFO = {
								DeviceName : "",
								DeviceUUID : "",
								DeviceLoc  : ""
							};

			var NODE1_INFO = {
								DeviceName : "",
								DeviceUUID : "",
								DeviceLoc  : ""
							};	
			
			var NODE2_INFO = {
								DeviceName : "",
								DeviceUUID : "",
								DeviceLoc  : ""
							};

			var NODE3_INFO = {
								DeviceName : "",
								DeviceUUID : "",
								DeviceLoc  : ""
							};

			// link status of devices
			var GWLinkRT = {linkNode: "G-R",   linkStatus: true, lineInx: 0, imgInxS:0, imgInxE: 1},
				RTLinkLB = {linkNode: "R-LB",  linkStatus: true, lineInx: 1, imgInxS:1, imgInxE: 2},
				LBLinkN1 = {linkNode: "LB-N1", linkStatus: true, lineInx: 2, imgInxS:2, imgInxE: 3},
				N1LinkN2 = {linkNode: "N1-N2", linkStatus: true, lineInx: 3, imgInxS:3, imgInxE: 4},
				N2LinkN3 = {linkNode: "N2-N3", linkStatus: true, lineInx: 4, imgInxS:4, imgInxE: 5};
			
			// linked status of devices
			var gtwOnline  = false,
				drt1Online = false,
				drt2Online = false,
				drt3Online = false,
				drt4Online = false,
				drt5Online = false;
				
			// image type of devices
			var gtwImgThickType  = false,
				drt1ImgThickType = false,
				drt2ImgThickType = false,
				drt3ImgThickType = false,
				drt4ImgThickType = false,
				drt5ImgThickType = false;
				
			// selected image for put conn or disconn image
			var gtwSelected  = {selected: false, conn: false},
				drt1Selected = {selected: false, conn: false},
				drt2Selected = {selected: false, conn: false},
				drt3Selected = {selected: false, conn: false},
				drt4Selected = {selected: false, conn: false},
				drt5Selected = {selected: false, conn: false};
				
			var c=document.getElementById("myCanvas"),
				ctx =c.getContext("2d"),	
				img =document.getElementById("imgGatewayThin"),	
				img1=document.getElementById("imgGatewayThick"),
				img5=document.getElementById("imgGatewayClr"),				
				img2=document.getElementById("imgDrtThin"),	
				img3=document.getElementById("imgDrtThick"),
				img4=document.getElementById("imgDrtClr"),	
				img6=document.getElementById("imgConn"),	
				img7=document.getElementById("imgDisconn"),	
				img8=document.getElementById("imgBlank"),	
				img12=document.getElementById("imgUpload"),
				img13=document.getElementById("imgDownload"),
				canvas = document.querySelector("canvas"),					
							
				// image position index
				gtwp  = {x: 182, y:  52, w: 84, h: 84},				
				drt1p = {x: 200, y: 221, w: 48, h: 48},
				drt2p = {x: 200, y: 376, w: 48, h: 48},
				drt3p = {x:  98, y: 507, w: 48, h: 48},
				drt4p = {x: 200, y: 507, w: 48, h: 48},
				drt5p = {x: 302, y: 507, w: 48, h: 48},
				
				// image placed location and size for thin color
				gtwThin  = {inx: img,  x:  gtwp.x, y:  gtwp.y, w: gtwp.w,  h:  gtwp.h},
				drt1Thin = {inx: img2, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Thin = {inx: img2, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Thin = {inx: img2, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Thin = {inx: img2, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Thin = {inx: img2, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},
				
				// image placed location and size for thick color image
				gtwThick  = {inx: img1, x:  gtwp.x, y:  gtwp.y, w: gtwp.w,  h:  gtwp.h},				
				drt1Thick = {inx: img3, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Thick = {inx: img3, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Thick = {inx: img3, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Thick = {inx: img3, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Thick = {inx: img3, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},
				
				// image placed location and size for Connected image
				gtwConn  = {inx: img6, x:  gtwp.x, y:  gtwp.y, w: gtwp.w,  h:  gtwp.h},				
				drt1Conn = {inx: img6, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Conn = {inx: img6, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Conn = {inx: img6, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Conn = {inx: img6, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Conn = {inx: img6, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},
				
				// image placed location and size for Disconnected image
				gtwDisconn  = {inx: img7, x:  gtwp.x, y:  gtwp.y, w: gtwp.w,  h:  gtwp.h},				
				drt1Disconn = {inx: img7, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Disconn = {inx: img7, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Disconn = {inx: img7, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Disconn = {inx: img7, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Disconn = {inx: img7, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},

				// image placed location and size for Upload image
				gtwUpload  = {inx: img12, x:  gtwp.x, y:  gtwp.y, w: gtwp.w,  h:  gtwp.h},				
				drt1Upload = {inx: img12, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Upload = {inx: img12, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Upload = {inx: img12, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Upload = {inx: img12, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Upload = {inx: img12, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},

				// image placed location and size for Download image
				gtwDownload  = {inx: img13, x:  gtwp.x, y:  gtwp.y, w: gtwp.w,  h:  gtwp.h},				
				drt1Download = {inx: img13, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Download = {inx: img13, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Download = {inx: img13, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Download = {inx: img13, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Download = {inx: img13, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},
				
				// image placed location and size for clear color image
				gtwClr =  {inx: img5, x: gtwp.x,  y: gtwp.y,  w: gtwp.w,  h:  gtwp.h},
				drt1Clr = {inx: img4, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Clr = {inx: img4, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Clr = {inx: img4, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Clr = {inx: img4, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Clr = {inx: img4, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},

				// image placed location and size for blank image
				gtwBlank =  {inx: img8, x: gtwp.x,  y: gtwp.y,  w: gtwp.w,  h: gtwp.h},
				drt1Blank = {inx: img8, x: drt1p.x, y: drt1p.y, w: drt1p.w, h: drt1p.h},
				drt2Blank = {inx: img8, x: drt2p.x, y: drt2p.y, w: drt2p.w, h: drt2p.h},
				drt3Blank = {inx: img8, x: drt3p.x, y: drt3p.y, w: drt3p.w, h: drt3p.h},
				drt4Blank = {inx: img8, x: drt4p.x, y: drt4p.y, w: drt4p.w, h: drt4p.h},
				drt5Blank = {inx: img8, x: drt5p.x, y: drt5p.y, w: drt5p.w, h: drt5p.h},
				
				// connection line of start and end
				gtwBottomP  = {x: gtwp.x+(gtwp.w/2),   y: (gtwp.y+gtwp.h)},
				RootTopP    = {x: drt1p.x+(drt1p.w/2), y:  drt1p.y},
				RootBottomP = {x: drt1p.x+(drt1p.w/2), y: (drt1p.y+drt1p.h)},
				LBTopP    	= {x: drt2p.x+(drt2p.w/2), y: (drt2p.y)},
				LBBottomP 	= {x: drt2p.x+15,		   y: (drt2p.y+drt2p.h)},
				N1TopP   	= {x: drt3p.x+(drt3p.w/2), y:  drt3p.y},
				N1RightP 	= {x: drt3p.x+(drt3p.w),   y: (drt3p.y+drt3p.h/2)},
				N2LeftP  	= {x: drt4p.x, 		  	   y: (drt4p.y+drt4p.h/2)},
				N2RightP 	= {x: drt4p.x+(drt4p.w),   y: (drt4p.y+drt4p.h/2)},
				N3LeftP  	= {x: drt5p.x, 			   y: (drt5p.y+drt5p.h/2)},
				
				// image text
				node0Name = " ",
				node1Name = "cFAN_NODE_1",
				node2Name = "cFAN_NODE_2",
				node3Name = "cFAN_NODE_3",
				node4Name = "cFAN_NODE_4",

				imgTextFont = "11pt NSimSun",
				gtwText    = "APP",
				RootText1  = "ROOT",
				RootText2  = "cFAN_ROOT",
				LBText1    = " ",					//"Local Base",
				LBText2    = node1Name,				//"cFAN_LB",
				Node1Text  = node2Name,				//"cFAN_NODE_1",
				Node2Text  = node3Name,				//"cFAN_NODE_2",
				Node3Text  = node4Name,				//"cFAN_NODE_3",

				// node name text index				
				
				// image text position
				gtwTextP    = {text: gtwText,    x: gtwp.x-15,  y: gtwp.y-7},
				RootText1P  = {text: RootText1,  x: drt1p.x+38, y: drt1p.y-18},
				RootText2P  = {text: RootText2,  x: drt1p.x+38, y: drt1p.y-1},
				LBText1P    = {text: LBText1, 	 x: drt2p.x+38, y: drt2p.y-18},
				LBText2P    = {text: LBText2, 	 x: drt2p.x+38, y: drt2p.y-1},
				Node1TextP  = {text: Node1Text,  x: drt3p.x-20,  y: drt3p.y+66},
				Node2TextP  = {text: Node2Text,  x: drt4p.x-20,  y: drt4p.y+66},
				Node3TextP  = {text: Node3Text,  x: drt5p.x-20,  y: drt3p.y+66},
								
				// initial image tooltip text
				gtwtext  = "Device Name: APP",

				drt1text = "Device Name:"         + ROOT_INFO.DeviceName + "<br>" +
						   "Device UUID:<br>"     + ROOT_INFO.DeviceUUID + "<br>" +
						   "Device Location:<br>" + ROOT_INFO.DeviceLoc,

				drt2text = "Device Name:"         + LB_INFO.DeviceName + "<br>" +
						   "Device UUID:<br>"     + LB_INFO.DeviceUUID + "<br>" +
						   "Device Location:<br>" + LB_INFO.DeviceLoc,

				drt3text = "Device Name:"         + NODE1_INFO.DeviceName + "<br>" +
						   "Device UUID:<br>"     + NODE1_INFO.DeviceUUID + "<br>" +
						   "Device Location:<br>" + NODE1_INFO.DeviceLoc,

				drt4text = "Device Name:"         + NODE2_INFO.DeviceName + "<br>" +
						   "Device UUID:<br>"     + NODE2_INFO.DeviceUUID + "<br>" +
						   "Device Location:<br>" + NODE2_INFO.DeviceLoc,

				drt5text = "Device Name:"         + NODE3_INFO.DeviceName + "<br>" +
						   "Device UUID:<br>"     + NODE3_INFO.DeviceUUID + "<br>" +
						   "Device Location:<br>" + NODE3_INFO.DeviceLoc,
			
			// create a tool-tip instance:		
				tgtw  = new ToolTip(myCanvas, gtwThin,  gtwtext,  200, 5000),				
				tdrt1 = new ToolTip(myCanvas, drt1Thin, drt1text, 180, 5000),
				tdrt2 = new ToolTip(myCanvas, drt2Thin, drt2text, 180, 5000),
				tdrt3 = new ToolTip(myCanvas, drt3Thin, drt3text, 180, 5000),
				tdrt4 = new ToolTip(myCanvas, drt4Thin, drt4text, 180, 5000),
				tdrt5 = new ToolTip(myCanvas, drt5Thin, drt5text, 180, 5000);

			// The Tool-Tip instance:
			function ToolTip(canvas, region, text, width, timeout) {				
				var me = this,                                // self-reference for event handlers
				    div = document.createElement("div"),      // the tool-tip div
				    parent = canvas.parentNode,               // parent node for canvas
				    visible = false;                          // current status
			  
				// set some initial styles, can be replaced by class-name etc.
				div.style.cssText = 
					"font-family:monospace;position:fixed;text-align:left;padding:7px;color:white;background:blue;pointer-events:none;width:" + width + "px";
				div.innerHTML = text;
			  
				// show the tool-tip
				this.show = function(pos) {
					if (!visible) {
						var str;
						str = updateTooltipText(region);
						div.innerHTML = str;
									
						visible = true;                           // lock so it's only shown once
						setDivPos(pos);				              // set position												
						parent.appendChild(div);                  // add to parent of canvas
						setTimeout(hide, timeout);                // timeout for hide
					}
				}
			  
				// hide the tool-tip
				function hide() {
					if(visible) {
						visible = false;                            // hide it after timeout					
						parent.removeChild(div);                    // remove from DOM
					}
				}

				// check mouse position, add limits as wanted... just for example:
				function check(e) {					
					var	pos = getPos(e),
						posAbs = {x: e.clientX-80, y: e.clientY},
						index = pos2Index(region),												
						linkStatus = getDvcOnlineStatus(index),
						thickStatus = getImagThickStatus(index);
						selFlag = getSelImgSelected(index);	
											
					if(!netMode) {
						visible = true;
					}
					
					if((netmodeEdge & 3) == 1) {					
						visible = false;
						netmodeEdge = 3;
					}					
					else if((netmodeEdge & 3) == 2) {
						visible = true;						
						netmodeEdge = 0;
					}	
					
					if (!visible &&
						pos.x >= region.x && pos.x < region.x + region.w &&
						pos.y >= region.y && pos.y < region.y + region.h) {
						
						div.innerHTML = updateDrtData(region);
						me.show(posAbs);
					}
					else if(visible && netMode) {	
						setDivPos(posAbs); 
						hide();
					/*	if(!selFlag) {
							if(linkStatus) {
								clrSelImgConn(index);								
							}
							else {
								setSelImgConn(index);
							}
							setSelImgSelected(index);
							rebuildConn();
							clrSelImgSelected(index);							
						} */
					}
					else if(visible && !netMode && thickStatus &&
						pos.x >= region.x && pos.x < region.x + region.w &&
						pos.y >= region.y && pos.y < region.y + region.h) {
						
						
						if((updnMode == 1) && (uploadCnt == 0)) {
							uploadCnt++;								
							drawImgUpload(index);
							if(downloadCnt == 0) {
								updnMode = 2;
							}
						}
						else if((updnMode == 2) && (downloadCnt == 0)) {
							downloadCnt++;								
							drawImgDownload(index);
							if(uploadCnt == 0) {
								updnMode = 1;
							}
						}
						//test1.innerHTML = "uploadCnt:"+uploadCnt+"   ";
						//test2.innerHTML = "downloadCnt:"+downloadCnt;
					}
				}
				
				// get mouse position relative to canvas
				function getPos(e) {
					var r = canvas.getBoundingClientRect();
						return {x: e.clientX - r.left, y: e.clientY - r.top}
				}
			  
				// update and adjust div position if needed (anchor to a different corner etc.)
				function setDivPos(pos) {
					if (visible){
						if (pos.x < 0) pos.x = 0;
						if (pos.y < 0) pos.y = 0;
						// other bound checks here
						div.style.left = pos.x + "px";
						div.style.top = pos.y + "px";
					}
				}
			  
				function adjNodeInfoPos(inx) {
					switch(inx) {
						case 0:
							return 0;
						case 1:
							return 1;
						case 2:
							return 3;
						case 3:
							return 2;
						case 4:
							return 1;
						case 5:
							return 0;
					}
				}

				function updateTooltipText(pos) {
					var text;
					var index = pos2Index(pos);
					if(index > 1) {
						index = (arrangeArray[index-2]+1);
					}
					
					switch(index) {
						case 0:
							text = "Device Name:" + GW_INFO.DeviceName;
							return text;

						case 1:
							text = "Device Name:"      + ROOT_INFO.DeviceName + "<br>" +
								"Device UUID:<br>"     + ROOT_INFO.DeviceUUID + "<br>" +
								"Device Location:<br>" + ROOT_INFO.DeviceLoc;
							return text;							

						case 2:
							text = "Device Name:"      + LB_INFO.DeviceName + "<br>" +
								"Device UUID:<br>"     + LB_INFO.DeviceUUID + "<br>" +
								"Device Location:<br>" + LB_INFO.DeviceLoc;
							return text;

						case 3:
							text = "Device Name:"      + NODE1_INFO.DeviceName + "<br>" +
								"Device UUID:<br>"     + NODE1_INFO.DeviceUUID + "<br>" +
								"Device Location:<br>" + NODE1_INFO.DeviceLoc;
							return text;

						case 4:
							text = "Device Name:"      + NODE2_INFO.DeviceName + "<br>" +
								"Device UUID:<br>"     + NODE2_INFO.DeviceUUID + "<br>" +
								"Device Location:<br>" + NODE2_INFO.DeviceLoc;
							return text;

						case 5:
							text = "Device Name:"      + NODE3_INFO.DeviceName + "<br>" +
								"Device UUID:<br>"     + NODE3_INFO.DeviceUUID + "<br>" +
								"Device Location:<br>" + NODE3_INFO.DeviceLoc;	
							return text;
					}
				}

				// we need to use shared event handlers:
				//canvas.addEventListener("mousemove", check);
				//canvas.addEventListener("mousedown", check);
				canvas.addEventListener("click", check);				
			}							

			// get node name
			function getNodeName(index) {
				switch (index) {
					case 0:
						return node0Name;
						break;
					case 1:
						return node1Name;
						break;
					case 2:
						return node2Name;
						break;
					case 3:
						return node3Name;
						break;
					case 4:
						return node4Name;
						break;					
				}
			}

			// set node name
			// namePos: position that renamed
			//			1: LBText2, 2: Node1Text, 3: Node2Text, 4: Node3Text
			// newNameIndex: index of new name
			//				0: blank
			//				1: cFAN_NODE_1, 2: cFAN_NODE_2
			//				3: cFAN_NODE_3, 4: cFAN_NODE_4
			function renameNodeName(namePos, newNameIndex) {
				switch (namePos) {
					case 0:
						LBText2P.text = getNodeName(newNameIndex);
						break;
					case 1:
						Node1TextP.text = getNodeName(newNameIndex);
						break;
					case 2:
						Node2TextP.text = getNodeName(newNameIndex);
						break;
					case 3:
						Node3TextP.text = getNodeName(newNameIndex);
						break;
					default:
						break;					
				}
				redrawImgLine();
			}

			// arrange node
			// input: arrangeArray[0] = node name of LBText2P.text
			//		  arrangeArray[1] = node name of Node1TextP.text
			//		  arrangeArray[2] = node name of Node2TextP.text
			//		  arrangeArray[3] = node name of Node3TextP.text
			function arrangeNodeName() {
				renameNodeName(0,arrangeArray[0]);
				renameNodeName(1,arrangeArray[1]);
				renameNodeName(2,arrangeArray[2]);
				renameNodeName(3,arrangeArray[3]);
			}			

			// show one node image
			// showPos: position
			//			0: Gateway, 1: ROOT
			//			2: LB(node1), 3: Node1(node2), 4: Node2(node3), 5: Node3(node4)
			// showMode: visible/invisible
			//			0: invisible, 1~4: visible
			function showOneNodeImg(showPos, showMode) {
				if(showMode == 0) {
					drawImgBlank(showPos);
				}
				else {
					drawImgThick(showPos);
				}
			}

			// show all node image			
			// Input: arrangeArray[0] = node1 position
			//		  arrangeArray[1] = node2 position
			//		  arrangeArray[2] = node3 position
			//		  arrangeArray[3] = node4 position
			//		content: 0=invisible, 1~4=visible
			function showAllNodeImage() {
				showOneNodeImg(2,arrangeArray[0]);
				showOneNodeImg(3,arrangeArray[1]);
				showOneNodeImg(4,arrangeArray[2]);
				showOneNodeImg(5,arrangeArray[3]);
			}

			// show one node link			
			//	showPos: 0=unlink
			//			 1=link ROOT-NODE1, 2=link NODE1-NODE2
			//			 3=link NODE2-NODE3, 4=link NODE4-NODE4
			//	visible: 0=invisible, 1=visible
			function showOneNodeLink(showPos, visible) {
				if(visible == 0) {
					unlinkLine(showPos);
				}
				else {
					linkLine(showPos);
				}
			}

			// show all node link			
			// Input: arrangeArray[0] = node1 position
			//		  arrangeArray[1] = node2 position
			//		  arrangeArray[2] = node3 position
			//		  arrangeArray[3] = node4 position
			//		content: 0=invisible, 1~4=visible
			//	content: 0=unlink
			//			 1=link ROOT-NODE1, 2=link NODE1-NODE2
			//			 3=link NODE2-NODE3, 4=link NODE4-NODE4
			function showAllNodeLink() {
				showOneNodeLink(1,arrangeArray[0]);
				showOneNodeLink(2,arrangeArray[1]);
				showOneNodeLink(3,arrangeArray[2]);
				showOneNodeLink(4,arrangeArray[3]);
			}

			function Init_Node_Info() {
				GW_INFO.DeviceName = cFAN_GW_DFT.DeviceName;

				ROOT_INFO.DeviceName = cFAN_ROOT_DFT.DeviceName;
				ROOT_INFO.DeviceUUID = cFAN_ROOT_DFT.DeviceUUID;
				ROOT_INFO.DeviceLoc  = cFAN_ROOT_DFT.DeviceLoc;

				LB_INFO.DeviceName = cFAN_LB_DFT.DeviceName;
				LB_INFO.DeviceUUID = cFAN_LB_DFT.DeviceUUID;
				LB_INFO.DeviceLoc  = cFAN_LB_DFT.DeviceLoc;

				NODE1_INFO.DeviceName = cFAN_NODE_1_DFT.DeviceName;
				NODE1_INFO.DeviceUUID = cFAN_NODE_1_DFT.DeviceUUID;
				NODE1_INFO.DeviceLoc  = cFAN_NODE_1_DFT.DeviceLoc;

				NODE2_INFO.DeviceName = cFAN_NODE_2_DFT.DeviceName;
				NODE2_INFO.DeviceUUID = cFAN_NODE_2_DFT.DeviceUUID;
				NODE2_INFO.DeviceLoc  = cFAN_NODE_2_DFT.DeviceLoc;

				NODE3_INFO.DeviceName = cFAN_NODE_3_DFT.DeviceName;
				NODE3_INFO.DeviceUUID = cFAN_NODE_3_DFT.DeviceUUID;
				NODE3_INFO.DeviceLoc  = cFAN_NODE_3_DFT.DeviceLoc;
			}

			function Set_Node_Info() {
				GW_INFO.DeviceName = cFAN_GW_INFO.DeviceName;

				ROOT_INFO.DeviceName = cFAN_ROOT_INFO.DeviceName;
				ROOT_INFO.DeviceUUID = cFAN_ROOT_INFO.DeviceUUID;
				ROOT_INFO.DeviceLoc  = cFAN_ROOT_INFO.DeviceLoc;

				LB_INFO.DeviceName = cFAN_LB_INFO.DeviceName;
				LB_INFO.DeviceUUID = cFAN_LB_INFO.DeviceUUID;
				LB_INFO.DeviceLoc  = cFAN_LB_INFO.DeviceLoc;

				NODE1_INFO.DeviceName = cFAN_NODE_1_INFO.DeviceName;
				NODE1_INFO.DeviceUUID = cFAN_NODE_1_INFO.DeviceUUID;
				NODE1_INFO.DeviceLoc  = cFAN_NODE_1_INFO.DeviceLoc;

				NODE2_INFO.DeviceName = cFAN_NODE_2_INFO.DeviceName;
				NODE2_INFO.DeviceUUID = cFAN_NODE_2_INFO.DeviceUUID;
				NODE2_INFO.DeviceLoc  = cFAN_NODE_2_INFO.DeviceLoc;

				NODE3_INFO.DeviceName = cFAN_NODE_3_INFO.DeviceName;
				NODE3_INFO.DeviceUUID = cFAN_NODE_3_INFO.DeviceUUID;
				NODE3_INFO.DeviceLoc  = cFAN_NODE_3_INFO.DeviceLoc;
			}

			function drawImgThin(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:
						ctx.drawImage(gtwThin.inx, gtwThin.x, gtwThin.y, gtwThin.w, gtwThin.h);
						break;
					case 1:
						ctx.drawImage(drt1Thin.inx, drt1Thin.x, drt1Thin.y, drt1Thin.w, drt1Thin.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Thin.inx, drt2Thin.x, drt2Thin.y, drt2Thin.w, drt2Thin.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Thin.inx, drt3Thin.x, drt3Thin.y, drt3Thin.w, drt3Thin.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Thin.inx, drt4Thin.x, drt4Thin.y, drt4Thin.w, drt4Thin.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Thin.inx, drt5Thin.x, drt5Thin.y, drt5Thin.w, drt5Thin.h);		 
						break;
				}
			}
			
			function drawImgThick(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:								
						ctx.drawImage(gtwThick.inx, gtwThick.x, gtwThick.y, gtwThick.w, gtwThick.h);
						break;
					case 1:
						ctx.drawImage(drt1Thick.inx, drt1Thick.x, drt1Thick.y, drt1Thick.w, drt1Thick.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Thick.inx, drt2Thick.x, drt2Thick.y, drt2Thick.w, drt2Thick.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Thick.inx, drt3Thick.x, drt3Thick.y, drt3Thick.w, drt3Thick.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Thick.inx, drt4Thick.x, drt4Thick.y, drt4Thick.w, drt4Thick.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Thick.inx, drt5Thick.x, drt5Thick.y, drt5Thick.w, drt5Thick.h);		 
						break;					
				}
			}

			function drawImgUpload(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:								
						ctx.drawImage(gtwUpload.inx, gtwUpload.x, gtwUpload.y, gtwUpload.w, gtwUpload.h);
						break;
					case 1:
						ctx.drawImage(drt1Upload.inx, drt1Upload.x, drt1Upload.y, drt1Upload.w, drt1Upload.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Upload.inx, drt2Upload.x, drt2Upload.y, drt2Upload.w, drt2Upload.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Upload.inx, drt3Upload.x, drt3Upload.y, drt3Upload.w, drt3Upload.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Upload.inx, drt4Upload.x, drt4Upload.y, drt4Upload.w, drt4Upload.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Upload.inx, drt5Upload.x, drt5Upload.y, drt5Upload.w, drt5Upload.h);		 
						break;					
				}
			}

			function drawImgDownload(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:								
						ctx.drawImage(gtwDownload.inx, gtwDownload.x, gtwDownload.y, gtwDownload.w, gtwDownload.h);
						break;
					case 1:
						ctx.drawImage(drt1Download.inx, drt1Download.x, drt1Download.y, drt1Download.w, drt1Download.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Download.inx, drt2Download.x, drt2Download.y, drt2Download.w, drt2Download.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Download.inx, drt3Download.x, drt3Download.y, drt3Download.w, drt3Download.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Download.inx, drt4Download.x, drt4Download.y, drt4Download.w, drt4Download.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Download.inx, drt5Download.x, drt5Download.y, drt5Download.w, drt5Download.h);		 
						break;					
				}
			}

			function drawImgConn(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:								
						ctx.drawImage(gtwConn.inx, gtwConn.x, gtwConn.y, gtwConn.w, gtwConn.h);
						break;
					case 1:
						ctx.drawImage(drt1Conn.inx, drt1Conn.x, drt1Conn.y, drt1Conn.w, drt1Conn.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Conn.inx, drt2Conn.x, drt2Conn.y, drt2Conn.w, drt2Conn.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Conn.inx, drt3Conn.x, drt3Conn.y, drt3Conn.w, drt3Conn.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Conn.inx, drt4Conn.x, drt4Conn.y, drt4Conn.w, drt4Conn.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Conn.inx, drt5Conn.x, drt5Conn.y, drt5Conn.w, drt5Conn.h);		 
						break;					
				}
			}
			
			function drawImgDisconn(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:								
						ctx.drawImage(gtwDisconn.inx, gtwDisconn.x, gtwDisconn.y, gtwDisconn.w, gtwDisconn.h);
						break;
					case 1:
						ctx.drawImage(drt1Disconn.inx, drt1Disconn.x, drt1Disconn.y, drt1Disconn.w, drt1Disconn.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Disconn.inx, drt2Disconn.x, drt2Disconn.y, drt2Disconn.w, drt2Disconn.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Disconn.inx, drt3Disconn.x, drt3Disconn.y, drt3Disconn.w, drt3Disconn.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Disconn.inx, drt4Disconn.x, drt4Disconn.y, drt4Disconn.w, drt4Disconn.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Disconn.inx, drt5Disconn.x, drt5Disconn.y, drt5Disconn.w, drt5Disconn.h);		 
						break;					
				}
			}
			
			function drawImgClr(imgInx) {
				drawImgBlank(imgInx);
				switch(imgInx) {
					case 0:	
						ctx.drawImage(gtwClr.inx, gtwClr.x, gtwClr.y, gtwClr.w, gtwClr.h);					
						break;
					case 1:
						ctx.drawImage(drt1Clr.inx, drt1Clr.x, drt1Clr.y, drt1Clr.w, drt1Clr.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Clr.inx, drt2Clr.x, drt2Clr.y, drt2Clr.w, drt2Clr.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Clr.inx, drt3Clr.x, drt3Clr.y, drt3Clr.w, drt3Clr.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Clr.inx, drt4Clr.x, drt4Clr.y, drt4Clr.w, drt4Clr.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Clr.inx, drt5Clr.x, drt5Clr.y, drt5Clr.w, drt5Clr.h);		 
						break;					
				}
			}
			
			function drawImgBlank(imgInx) {
				switch(imgInx) {
					case 0:	
						ctx.drawImage(gtwBlank.inx, gtwBlank.x, gtwBlank.y, gtwBlank.w, gtwBlank.h);					
						break;
					case 1:
						ctx.drawImage(drt1Blank.inx, drt1Blank.x, drt1Blank.y, drt1Blank.w, drt1Blank.h);				 
						break;
					case 2:
						ctx.drawImage(drt2Blank.inx, drt2Blank.x, drt2Blank.y, drt2Blank.w, drt2Blank.h);			 
						break;
					case 3:
						ctx.drawImage(drt3Blank.inx, drt3Blank.x, drt3Blank.y, drt3Blank.w, drt3Blank.h);		 
						break;
					case 4:
						ctx.drawImage(drt4Blank.inx, drt4Blank.x, drt4Blank.y, drt4Blank.w, drt4Blank.h);	 
						break;
					case 5:
						ctx.drawImage(drt5Blank.inx, drt5Blank.x, drt5Blank.y, drt5Blank.w, drt5Blank.h);		 
						break;					
				}
			}
			
			// true = connected image
			function setSelImgConn(index) {
				switch (index) {
					case 0:
						gtwSelected.conn = true;
						break;
					case 1:
						drt1Selected.conn = true;
						break;
					case 2:
						drt2Selected.conn = true;
						break;
					case 3:
						drt3Selected.conn = true;
						break;
					case 4:
						drt4Selected.conn = true;
						break;
					case 5:
						drt5Selected.conn = true;
						break;
				}
			}
			
			// false = diconnected image
			function clrSelImgConn(index) {
				switch (index) {
					case 0:
						gtwSelected.conn = false;
						break;
					case 1:
						drt1Selected.conn = false;
						break;
					case 2:
						drt2Selected.conn = false;
						break;
					case 3:
						drt3Selected.conn = false;
						break;
					case 4:
						drt4Selected.conn = false;
						break;
					case 5:
						drt5Selected.conn = false;
						break;
				}
			}
			
			function setSelImgSelected(index) {
				switch (index) {
					case 0:
						gtwSelected.selected = true;
						break;
					case 1:
						drt1Selected.selected = true;
						break;
					case 2:
						drt2Selected.selected = true;
						break;
					case 3:
						drt3Selected.selected = true;
						break;
					case 4:
						drt4Selected.selected = true;
						break;
					case 5:
						drt5Selected.selected = true;
						break;
				}
			}
			
			function clrSelImgSelected(index) {
				switch (index) {
					case 0:
						gtwSelected.selected = false;
						break;
					case 1:
						drt1Selected.selected = false;
						break;
					case 2:
						drt2Selected.selected = false;
						break;
					case 3:
						drt3Selected.selected = false;
						break;
					case 4:
						drt4Selected.selected = false;
						break;
					case 5:
						drt5Selected.selected = false;
						break;
				}
			}

			function getSelImgSelected(index) {
				switch (index) {
					case 0:
						return gtwSelected.selected;
					case 1:
						return drt1Selected.selected;						
					case 2:
						return drt2Selected.selected;
					case 3:
						return drt3Selected.selected;
					case 4:
						return drt4Selected.selected;
					case 5:
						return drt5Selected.selected;
				}
			}
			
			function getSelImgConn(index) {
				switch (index) {
					case 0:
						return gtwSelected.conn;
					case 1:
						return drt1Selected.conn;					
					case 2:
						return drt2Selected.conn;
					case 3:
						return drt3Selected.conn;
					case 4:
						return drt4Selected.conn;
					case 5:
						return drt5Selected.conn;
				}
			}
			
			function rebuildConn() {
				if(gtwSelected.selected) {
					if(gtwSelected.conn) {
						GWLinkRT.linkStatus = true;
					}
					else if(!gtwSelected.conn) {
						GWLinkRT.linkStatus = false;
					}
					redrawImgLine();
				}
				else if(drt1Selected.selected) {
					if(drt1Selected.conn) {
						RTLinkLB.linkStatus = true;
					}
					else {
						RTLinkLB.linkStatus = false;
					}
					redrawImgLine();					
				}
				
				else if(drt2Selected.selected) {
					if(drt2Selected.conn) {
						LBLinkN1.linkStatus = true;						
					}
					else {
						LBLinkN1.linkStatus = false;						
					}
					redrawImgLine();					
				}
				
				else if(drt3Selected.selected) {
					if(drt3Selected.conn) {
						N1LinkN2.linkStatus = true;
					}
					else {
						N1LinkN2.linkStatus = false;
					}
					redrawImgLine();					
				}

				else if(drt4Selected.selected) {
					if(drt4Selected.conn) {
						N2LinkN3.linkStatus = true;
					}
					else {
						N2LinkN3.linkStatus = false;
					}
					redrawImgLine();					
				}				
			}
			
			function updateDrtData(pos) {
				if(pos.x==gtwp.x && pos.y==gtwp.y) return gtwtext;
				else if(pos.x==drt1p.x && pos.y==drt1p.y) return drt1text;
				else if(pos.x==drt2p.x && pos.y==drt2p.y) return drt2text;
				else if(pos.x==drt3p.x && pos.y==drt3p.y) return drt3text;
				else if(pos.x==drt4p.x && pos.y==drt4p.y) return drt4text;
				else if(pos.x==drt5p.x && pos.y==drt5p.y) return drt5text;
				else return "not available";
			}
			
			function pos2Index(pos) {
				if(pos.x==gtwp.x && pos.y==gtwp.y) return 0;
				else if(pos.x==drt1p.x && pos.y==drt1p.y) return 1;
				else if(pos.x==drt2p.x && pos.y==drt2p.y) return 2;
				else if(pos.x==drt3p.x && pos.y==drt3p.y) return 3;
				else if(pos.x==drt4p.x && pos.y==drt4p.y) return 4;
				else if(pos.x==drt5p.x && pos.y==drt5p.y) return 5;
				else return 0;
			}
			
			function getDvcOnlineStatus(index) {
				switch (index) {
					case 0:
						if(GWLinkRT.linkStatus) {
							gtwOnline = true;
						}
						else {
							gtwOnline = false;
						}
						return gtwOnline;
						
					case 1:
						if(RTLinkLB.linkStatus) {
							drt1Online = true;
						}
						else {
							drt1Online = false;
						}
						return drt1Online;
						
					case 2:
						if(LBLinkN1.linkStatus) {
							drt2Online = true;
						}
						else {
							drt2Online = false;
						}
						return drt2Online;
						
					case 3:
						if(N1LinkN2.linkStatus) {
							drt3Online = true;
						}
						else {
							drt3Online = false;
						}
						return drt3Online;
						
					case 4:
						if(N2LinkN3.linkStatus) {
							drt4Online = true;
						}
						else {
							drt4Online = false;
						}
						return drt4Online;											
				}
			}
			
			function clearCanvas() {
				ctx.clearRect(0, 0, c.width, c.height);
			}
			
			function clearLine(start,end) {		
				<!-- setLineDash([x,y]) x=segment px, y=gap px -->		
				ctx.strokeStyle = '#ffffff';
				ctx.lineWidth="1";
				ctx.setLineDash([3,3]);	
				ctx.beginPath();   
				ctx.moveTo(start.x,start.y);  
				ctx.lineTo(end.x,end.y);   		
				ctx.stroke();			
			}
			
			function drawLine(start,end) {						
				clearLine(start,end);				
				ctx.strokeStyle = '#0000ff';
				ctx.lineWidth="1";
				ctx.setLineDash([3,3]);	
				ctx.beginPath();   
				ctx.moveTo(start.x,start.y);  
				ctx.lineTo(end.x,end.y);   		
				ctx.stroke();	
			}						
			
			function putText(imgTextP,txtFont) {
				ctx.font = txtFont;
				ctx.fillStyle = '#000000';
				ctx.fillText(imgTextP.text, imgTextP.x, imgTextP.y);
			}

			function linkLine(lineInx) {
				switch (lineInx) {					
					case 0:
						drawLine(gtwBottomP,RootTopP);
						break;
					case 1:
						drawLine(RootBottomP,LBTopP);
						break;
					case 2:
						drawLine(LBBottomP,N1TopP);
						break;
					case 3:
						drawLine(N1RightP,N2LeftP);
						break;
					case 4:
						drawLine(N2RightP,N3LeftP);
						break;
				}			
			}
			
			function unlinkLine(lineInx) {
				switch (lineInx) {					
					case 0:
						clearLine(gtwBottomP,RootTopP);
						break;
					case 1:
						clearLine(RootBottomP,LBTopP);
						break;
					case 2:
						clearLine(LBBottomP,N1TopP);
						break;
					case 3:
						clearLine(N1RightP,N2LeftP);
						break;
					case 4:
						clearLine(N2RightP,N3LeftP);
						break;			
				}			
			}									
			
			// put device name
			function putDvcName() {
				putText(gtwTextP,imgTextFont);
				putText(RootText1P,imgTextFont);
				putText(RootText2P,imgTextFont);
				putText(LBText1P,imgTextFont);
				putText(LBText2P,imgTextFont);
				putText(Node1TextP,imgTextFont);
				putText(Node2TextP,imgTextFont);
				putText(Node3TextP,imgTextFont);
			}

			// put link line and image from link status of devices
			function redrawImgLine() {
				clearCanvas();
				putDvcName();
				if(!GWLinkRT.linkStatus) {
					unlinkLine(GWLinkRT.lineInx);
					drawImgThin(GWLinkRT.imgInxS);
					gtwImgThickType = false;
				}
				else {
					linkLine(GWLinkRT.lineInx);	
					drawImgThick(GWLinkRT.imgInxS);	
					gtwImgThickType = true;			
				}
				
				if(!RTLinkLB.linkStatus) {
					unlinkLine(RTLinkLB.lineInx);
					if(!GWLinkRT.linkStatus) {
						drawImgThin(RTLinkLB.imgInxS);
						drt1ImgThickType = false;
					}
					else {
						drawImgThick(RTLinkLB.imgInxS);
						drt1ImgThickType = true;
					}
				}
				else {
					linkLine(RTLinkLB.lineInx);	
					drawImgThick(RTLinkLB.imgInxS);
					drt1ImgThickType = true;
				}
			
				if(!LBLinkN1.linkStatus) {
					unlinkLine(LBLinkN1.lineInx);
					drawImgThin(LBLinkN1.imgInxS)
					drt3ImgThickType = false;
				}
				else {
					linkLine(LBLinkN1.lineInx);
					drawImgThick(LBLinkN1.imgInxS)
					drt3ImgThickType = true;
				}			
				
				if(!N1LinkN2.linkStatus) {
					unlinkLine(N1LinkN2.lineInx);
					drawImgThin(N1LinkN2.imgInxS)
					drt4ImgThickType = false;
				}
				else {
					linkLine(N1LinkN2.lineInx);
					drawImgThick(N1LinkN2.imgInxS)
					drt4ImgThickType = true;
				}
				
				if(!N2LinkN3.linkStatus) {
					unlinkLine(N2LinkN3.lineInx);
					drawImgThin(N2LinkN3.imgInxS)
					drawImgThin(N2LinkN3.imgInxE)
					drt5ImgThickType = false;
				}
				else {
					linkLine(N2LinkN3.lineInx);
					drawImgThick(N2LinkN3.imgInxS)
					drawImgThick(N2LinkN3.imgInxE)
					drt5ImgThickType = true;
				}				
			}
			
			function getImagThickStatus(index) {
				switch (index) {
					case 0:
						return gtwImgThickType;
					case 1:
						return drt1ImgThickType;
					case 2:
						return drt2ImgThickType;
					case 3:
						return drt3ImgThickType;
					case 4:
						return drt4ImgThickType;
					case 5:
						return drt5ImgThickType;
				}
			}
			
			function linkAll() {
				GWLinkRT.linkStatus = true;
				RTLinkLB.linkStatus = true;
				LBLinkN1.linkStatus = true;
				N1LinkN2.linkStatus = true;
				N2LinkN3.linkStatus = true;
				redrawImgLine();
			}
			
			function unlinkAll() {
				GWLinkRT.linkStatus = false;
				RTLinkLB.linkStatus = false;
				LBLinkN1.linkStatus = false;
				N1LinkN2.linkStatus = false;
				N2LinkN3.linkStatus = false;
				redrawImgLine();
			}
			
			function Xfer() {
				const obj = JSON.parse(cFAN_ROOT_INFO);				
				test1.innerHTML = obj.DeviceName;
				test2.innerHTML = obj.DeviceUUID;
				test3.innerHTML = obj.DeviceLoc;
			}
			
			function resumeConn() {
				redrawImgLine();
				uploadCnt = 0;
				downloadCnt = 0;
				updnMode = 1;
			}
			function changeMode() {
				var modeBtnImg = document.getElementById("imagMode");
					//xferBtnImg = document.getElementById("imageXfer");
					//linkBtnImg = document.getElementById("imageLink");
					//unlinkBtnImg = document.getElementById("imageUnlink");
					
				if(netMode) {
					netMode = false;
					modeBtnImg.src="./image/MingcuteTransfer4Line.svg";
					//xferBtnImg.src="./image/IconParkOutlineCommunication.svg";
					//linkBtnImg.src="./image/RaphaelConnectThin.svg";
					//unlinkBtnImg.src="./image/RaphaelDisconnectThin.svg";
					//document.getElementById("xferBtn").disabled = false;
					//document.getElementById("unlinkBtn").disabled = true;
					//document.getElementById("linkBtn").disabled = true;
					document.getElementById("linkBtn").style.display = "none";
					document.getElementById("unlinkBtn").style.display = "none";
					document.getElementById("xferBtn").style.display = "";
				}
				else {
					modeBtnImg.src="./image/IconoirNetworkReverse.svg";
					//xferBtnImg.src="./image/IconParkOutlineCommunicationThin.svg";
					//linkBtnImg.src="./image/RaphaelConnect.svg";
					//unlinkBtnImg.src="./image/RaphaelDisconnect.svg";
					netMode = true;
					//document.getElementById("xferBtn").disabled = true;
					//document.getElementById("unlinkBtn").disabled = false;
					//document.getElementById("linkBtn").disabled = false;
					document.getElementById("linkBtn").style.display = "";
					document.getElementById("unlinkBtn").style.display = "";
					document.getElementById("xferBtn").style.display = "none";
					redrawImgLine();
				}
				netmodeEdge <<= 1;
				if(netMode) {
					netmodeEdge |= 1;
				}
				uploadCnt = 0;
				downloadCnt = 0;
				updnMode = 1;
			}
			
			function getRoutingMap() {
				fetch("http://118.163.52.188:8080/api/routing-map", {
					method: 'GET'
				})
				.then(response => response.json())
				.then(jsonData => {
					console.log(jsonData);
					drt1json = JSON.stringify(jsonData, null, 2);
					test1.innerHTML = drt1json;
				});				
			}			
			
			function postRoutingMap() {
				fetch('https://httpbin.org/post', {
					method: 'POST',
					headers: {
					'Accept': 'application/json, text/plain, */*',
					'Content-Type': 'application/json'
					},
					body: JSON.stringify({a: 7, str: 'Some string: &=&'})
				})
				.then(res => res.json())
				.then(res => console.log(res));
			}
			

			window.onload=function()
			{
				var el=document.getElementById('xferBtn');
				el.onclick=function(){
					var my_text=prompt('Enter message here');
					if(my_text) alert(my_text);					
				}
			}
			
			img.addEventListener("load", (e) => {										  
				redrawImgLine();
			  	changeMode();
				Init_Node_Info();
				unlinkAll();
				arrangeNodeName();
				showAllNodeImage();		  
				showAllNodeLink();
			});	
			
		</script>

		<script>			
			async function linkBluetoothClick() {
				
				if(enConnBLE == 1) {
					try {
						device = await navigator.bluetooth.requestDevice({
						//filters: [{services: [serviceUuid]}],
						filters: [{name: connDeviceName}],
						//acceptAllDevices: true,
						optionalServices: [serviceUuid]		  
						});
						device.addEventListener('gattserverdisconnected', onDisconnected);

						const server = await device.gatt.connect();
						const service = await server.getPrimaryService(serviceUuid);
						notifyCharacteristic = await service.getCharacteristic(notifyCharacteristicUuid);
						writeCharacteristic = await service.getCharacteristic(writeCharacteristicUuid);

						await notifyCharacteristic.startNotifications();
						notifyCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
						imgBle.src="./image/FoundationBluetooth.svg";
						enConnBLE = 0;						
						console.log("connected")
						setSelImgConn(0);							
						setSelImgSelected(0);
						rebuildConn();
						Set_Node_Info();						
					} catch (error) {
						console.error('Error:', error);
					}
				}
				else {
					disconnCmd = 1;
				}														
  			}

			function onDisconnected() {
				console.log("disconnected")
				imgBle.src="./image/MdiBluetoothOff.svg";
				disconnCmd = 0;
				enConnBLE = 1;
				clrSelImgConn(0);							
				setSelImgSelected(0);
				rebuildConn();	
				Init_Node_Info();			
				//document.getElementById('status').innerText = 'Status: Disconnected';
			}

			async function sendMessage() {			
				if (writeCharacteristic) {
					//const message = document.getElementById('message').value;
					const message  = '1234';
					const encoder = new TextEncoder('utf-8');
					const data = encoder.encode(message);
					try {
						await writeCharacteristic.writeValue(data);	
						console.log('Message sent');
					} catch (error) {
						console.error('Failed to send message', error);
					}
				} else {
					console.error('Not connected to a device');
				}
			}

			function handleCharacteristicValueChanged(event) {
				const timestamp = formatDatetime(new Date());
				let value = [];		//event.target.value.getUint8(0);
				for(i = 0; i < 32; i++) {
					value[i] = event.target.value.getUint8(i);
				}

				// move NTY into arrangeArray
				for(i = 0; i < 4; i++) {					
					if(value[i] == 255) {
						value[i] = 0;
					}
					arrangeArray[3-i] = value[i];					
				}

				// adjust node position
				for(i = 0; i < 4; i++) {
					if(arrangeArray[0] == 0) {
						arrangeArray[0] = arrangeArray[1];
						arrangeArray[1] = arrangeArray[2];
						arrangeArray[2] = arrangeArray[3];
						arrangeArray[3] = 0;						
					}
					else {
						break;
					}				
				}
				arrangeNodeName();
				showAllNodeImage();
				showAllNodeLink();
				
				//const decoder = new TextDecoder('utf-8');
				//const message = decoder.decode(value);
				//console.log(value);
				
				if(disconnCmd == 1) {
					if (device.gatt.connected) {
						device.gatt.disconnect();
						imgBle.src="./image/MdiBluetoothOff.svg";
						disconnCmd = 0;
						enConnBLE = 1;
					}				
				}
			}

			function messageHandler(id, data) {
				if (!messageStore[id]) {
					messageStore[id] = { message: '', reassembled: true };
				}

				const messageInfo = messageStore[id];

				if (data === "SOM") {
					if (messageInfo.reassembled) {
					messageInfo.reassembled = false;
					messageInfo.message = '';
					}
				} else if (data === "EOM") {
					if (!messageInfo.reassembled) {
					messageInfo.reassembled = true;
					}
				} else if (!messageInfo.reassembled) {
					messageInfo.message += data;
				}
			}

			function formatDatetime(date) {
				const year = date.getFullYear();
				const month = (date.getMonth() + 1).toString().padStart(2, '0');
				const day = date.getDate().toString().padStart(2, '0');
				const hours = date.getHours().toString().padStart(2, '0');
				const minutes = date.getMinutes().toString().padStart(2, '0');
				const seconds = (date.getSeconds() + date.getMilliseconds() / 1000).toFixed(2).padStart(5, '0');
				const formattedDatetime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}Z`;

				return formattedDatetime
			}		
		</script>
	</body>

</html>
